  - id: darkbit-gcp-76
    title: Log Metric Filter And Alert Should Notify On Firewall Rule Changes
    description: |
      A metric filter and alert should exist for VPC network firewall rule changes.
    remediation: |-
      Create a [logging metric](https://console.cloud.google.com/logs/metrics) with the following
      advanced filter:

      ```
      resource.type="gce_firewall_rule"
      AND jsonPayload.event_subtype="compute.firewalls.patch"
      OR jsonPayload.event_subtype="compute.firewalls.insert"
      ```

      In the Metric Editor menu, fill out the `name` field. Set `Units` to `1` (default)
      and `Type` to `Counter`. This will ensure that the log metric counts the number
      of log entries matching the user's advanced logs query.

      Next, [Create an alert from the Metric](https://console.cloud.google.com/logs/metrics) with
      an alert threshold of `0` to trigger a notification every time firewall rules are changed.
    validation: |-
      List the log metrics.

      ```
      gcloud beta logging metrics list --format json
      ```

      Ensure that the output contains at least one metrics with the filter:

      ```
      resource.type="gce_firewall_rule"
        AND jsonPayload.event_subtype="compute.firewalls.patch"
        OR jsonPayload.event_subtype="compute.firewalls.insert"
      ```

      List the alerting policies.

      ```
      gcloud alpha monitoring policies list --format json
      ```

      Ensure that at least one alert policy has `conditions.conditionThreshold.filter`
      set to `metric.type="logging.googleapis.com/user/<Log Metric Name>"` and `enabled` set to `true`.
    impact: 8
    nodes:
      - GCP_LOGGING_LOGSINK
      - GCP_CLOUDRESOURCEMANAGER_PROJECT
    refs:
      - text: Log Based Metrics
        url: https://cloud.google.com/logging/docs/logs-based-metrics/
      - text: Monitoring Alerts
        url: https://cloud.google.com/monitoring/alerts/
    public: true
    tags:
      - cis:
          - gcp-cis1.1
          - gcp-cis1.1-level1
          - gcp-cis1.1-scored
          - gcp-cis1.1-2
          - gcp-cis1.1-2.7
      - nist-csf:
          - nist-csf-todo
      - google cloud
